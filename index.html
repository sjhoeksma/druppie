<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Druppie: Full Cycle Architecture (Interactive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 
       v11 Updates:
       - SPLIT: Identity column now contains "Bouwblok Definities" & "IAM".
       - LOGIC: Simulations now query the Block Registry before planning.
       - BASE: Built upon user's custom version (loop-user, click-handlers).
       - SPECIFICATION: Enhanced descriptions for clarity.
    -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #0f172a;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* --- KANBAN BOARD --- */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            background: #cbd5e1;
            padding: 4px;
            border-radius: 6px;
        }

        .kanban-col {
            background: #f1f5f9;
            border-radius: 4px;
            padding: 6px;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            border-top: 3px solid #94a3b8;
        }

        .kanban-header {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        /* Split Column 5 */
        .split-container {
            display: flex;
            gap: 4px;
            height: 100%;
            flex-grow: 1;
        }

        .split-col {
            flex: 1;
            background: #e2e8f0;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 4px;
            border: 1px dashed #cbd5e1;
            position: relative;
        }

        .split-label {
            font-size: 0.5rem;
            font-weight: bold;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .project-card {
            background: white;
            padding: 6px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 3px solid #3b82f6;
            font-size: 0.7rem;
            font-weight: 600;
            color: #334155;
            width: 100%;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- DIAGRAM --- */
        .diagram-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
            position: relative;
        }

        .arch-card {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem;
            position: relative;
            z-index: 10;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .arch-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #94a3b8;
        }

        /* Orchestrator Internals */
        .internal-block {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            font-size: 0.6rem;
            color: white;
            transition: all 0.3s;
        }

        .internal-active {
            background: white;
            color: #2563eb;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Highlighting */
        .active-comp {
            transform: scale(1.02);
            z-index: 20;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        .ring-blue {
            border-color: #3b82f6;
            border-width: 2px;
        }

        .ring-purple {
            border-color: #9333ea;
            border-width: 2px;
        }

        .ring-orange {
            border-color: #f97316;
            border-width: 2px;
        }

        .ring-green {
            border-color: #22c55e;
            border-width: 2px;
        }

        .ring-red {
            border-color: #f87171;
            border-width: 2px;
        }

        /* Animation Packet */
        .packet {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            z-index: 50;
            background: #ef4444;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }

        /* Approver Pulse */
        .pulse-req {
            animation: pulsePurple 1.5s infinite;
        }

        @keyframes pulsePurple {
            0% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(147, 51, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
            }
        }

        /* Chat & Terminal */
        .chat-bubble {
            font-size: 0.75rem;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 85%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .bubble-user {
            background-color: #dbeafe;
            color: #1e40af;
            border-top-right-radius: 0;
        }

        .bubble-ai {
            background-color: white;
            border: 1px solid #e2e8f0;
            color: #334155;
            border-top-left-radius: 0;
        }

        .loop-user {
            background-color: lightsalmon;
            border: 1px solid #e2e8f0;
            color: #334155;
            border-top-left-radius: 0;
        }


        .terminal-line {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            padding: 1px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .term-info {
            color: #94a3b8;
        }

        .term-success {
            color: #4ade80;
        }

        .term-warn {
            color: #fbbf24;
        }

        .term-error {
            color: #f87171;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark-scroll ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* --- MARKDOWN STYLING (GitHub Flavor-ish) --- */
        #md-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            color: #24292f;
        }

        #md-content h1,
        #md-content h2,
        #md-content h3,
        #md-content h4,
        #md-content h5,
        #md-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
            color: #1f2937;
        }

        #md-content h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        #md-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        #md-content h3 {
            font-size: 1.25em;
        }

        #md-content p {
            margin-top: 0;
            margin-bottom: 16px;
        }

        #md-content a {
            color: #0969da;
            text-decoration: none;
        }

        #md-content a:hover {
            text-decoration: underline;
        }

        #md-content ul,
        #md-content ol {
            padding-left: 2em;
            margin-top: 0;
            margin-bottom: 16px;
        }

        #md-content ul {
            list-style-type: disc;
        }

        #md-content ol {
            list-style-type: decimal;
        }

        #md-content li {
            margin-top: 0.25em;
        }

        #md-content blockquote {
            padding: 0 1em;
            color: #57606a;
            border-left: 0.25em solid #d0d7de;
            margin: 0 0 16px 0;
        }

        /* Tables */
        #md-content table {
            border-spacing: 0;
            border-collapse: collapse;
            margin-top: 0;
            margin-bottom: 16px;
            width: 100%;
            overflow: auto;
        }

        #md-content table th,
        #md-content table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }

        #md-content table th {
            font-weight: 600;
            background-color: #f6f8fa;
        }

        #md-content table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }

        /* Code */
        #md-content code {
            padding: .2em .4em;
            margin: 0;
            font-size: 85%;
            background-color: #afb8c133;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
        }

        #md-content pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        #md-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }

        /* Mermaid */
        div.mermaid {
            background: white;
            padding: 10px;
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- SPECIFICATION -->
    <script>
        const SPEC = {
            "comp-copilot": {
                "name": "Druppie UI (Copilot)",
                "description": "De gebruikersinterface (Chat) dit kan Copilot zijn voor simple vragen of een specifieke Druppie Applicatie. Ontvangt vragen en stuurt deze door naar de backend.",
                "steps": [
                    "Gebruiker verstuurt prompt.",
                    "Interface rendert chat bubbles.",
                    "Verzoek wordt doorgestuurd naar Orchestrator."
                ],
                "design": {
                    "components": ["Frontend UI", "API Gateway"],
                    "dataFlow": ["Gebruiker -> UI -> Backend"]
                },
                "prompts": {
                    "research": "Analyseer user requirements voor nieuwe chat interacties.",
                    "build": "Genereer responsive HTML/JS componenten voor de chat interface.",
                    "test": "Valideren van rendering van markdown en user input handling.",
                    "deploy": "Verpakken van frontend assets en deployen naar static host."
                }
            },
            "comp-compliance": {
                "name": "Druppie Compliance Layer",
                "description": "Overkoepelende beveiligingslaag. Voert continue, dagelijkse compliance checks uit over alle logs en markeert kwetsbaarheden op basis van audit regels.",
                "steps": [
                    "Monitoren van logs en activiteit.",
                    "Valideren tegen compliance regels.",
                    "Markeren van afwijkingen.",
                    "Genereren van compliance rapporten."
                ],
                "design": {
                    "components": ["Security Scanner", "Audit Rules Engine", "Reporting Dashboard"],
                    "dataFlow": ["Logs -> Scanner -> Audit DB -> Dashboard"]
                },
                "prompts": {
                    "research": "Identificeer relevante security frameworks (ISO27001, AVG).",
                    "build": "Schrijf audit regels voor log analyse en anomaly detection.",
                    "test": "Draai compliance checks tegen test datasets met bekende kwetsbaarheden.",
                    "deploy": "Activeer ruleset in productie monitoring pipeline."
                }
            },
            "comp-blocks": {
                "name": "Bouwblok Definities",
                "description": "Catalogus met specificaties van bouwblokken, skills, agents en MCP services. Druppie Core raadpleegt dit register om te bepalen welke capability de vraag kan beantwoorden.",
                "steps": [
                    "Registreren van nieuwe blokken.",
                    "Zoeken naar geschikte blokken op basis van intentie.",
                    "Versiebeheer van definities."
                ],
                "design": {
                    "components": ["Registry DB", "Search API", "Definition Schema"],
                    "dataFlow": ["Core -> Registry -> Capability Metadata"]
                },
                "prompts": {
                    "research": "Definieer metadata schema voor capability discovery.",
                    "build": "Implementeer vector-search voor semantisch zoeken van skills.",
                    "test": "Verifieer of correcte skills worden gevonden bij vage omschrijvingen.",
                    "deploy": "Indexeer initi√´le set van systeem capabilities."
                }
            },
            "comp-entra": {
                "name": "Identity & Access Management (IAM)",
                "description": "Beheert identiteiten en toegang (IAM). Zorgt ervoor dat alleen geautoriseerde gebruikers acties uitvoeren.",
                "steps": [
                    "Authenticeren van gebruiker.",
                    "Valideren van tokens.",
                    "Toewijzen van rollen en rechten."
                ],
                "design": {
                    "components": ["Identity Provider", "Token Service", "Directory"],
                    "dataFlow": ["UI -> IAM -> Access Token"]
                },
                "prompts": {
                    "research": "Bepaal benodigde IAM rollen en scopes.",
                    "build": "Configureer App Registration en claim mapping policy.",
                    "test": "Valideer token generatie en rol toewijzing.",
                    "deploy": "Provision service principal in tenant."
                }
            },
            "comp-orch": {
                "name": "Druppie Core (Orchestrator)",
                "description": "Het brein van de architectuur (Semantic Kernel). Gebruikt LLMs vanuit foundry of eigen datacenter om intentie te bepalen en taken te plannen.",
                "steps": [
                    "Ontvangen van gebruikersvraag.",
                    "Analyseren van intentie (Planner).",
                    "Raadplegen van geheugen en context.",
                    "Aansturen van downstream agents."
                ],
                "design": {
                    "components": ["Semantic Kernel", "Planner", "Memory", "RAG", "Safety Filter"],
                    "dataFlow": ["Input -> Safety -> Planner -> Execution -> Output"]
                },
                "prompts": {
                    "research": "Ontwerp orchestratie logica en planner strategie.",
                    "build": "Implementeer Semantic Kernel logic en plugin integratie.",
                    "test": "Test planner gedrag bij complexe, multi-step prompts.",
                    "deploy": "Deploy core service en verbind met LLM backend."
                }
            },
            "comp-policy": {
                "name": "Policy Engine",
                "description": "Controleert of verzoeken voldoen aan bedrijfsregels (bijv. Wetgeving, Ethiek, en controls zoals geen SQL toegang zonder goedkeuring).",
                "steps": [
                    "Analyseren van voorgesteld actieplan.",
                    "Toetsen aan beleidsregels.",
                    "Blokkeren of flaggen van risico's.",
                    "Initieren van goedkeuringsflow indien nodig."
                ],
                "design": {
                    "components": ["Rule Engine", "Policy Database", "Violation Handler"],
                    "dataFlow": ["Orchestrator -> Policy Check -> Decision"]
                },
                "prompts": {
                    "research": "Inventariseer risico's en vereiste controls.",
                    "build": "Codificeer beleid in Open Policy Agent (OPA) regels.",
                    "test": "Simuleer violations en verifieer blocking behaviour.",
                    "deploy": "Push policy bundle naar enforcement points."
                }
            },
            "comp-ciso": {
                "name": "Mens in de Loop",
                "description": "Human-in-the-Loop stap. Vereist handmatige goedkeuring voor risicovolle acties of specifieke kennisvragen.",
                "steps": [
                    "Ontvangen van goedkeuringsverzoek.",
                    "Menselijke beoordeling van risico.",
                    "Goedkeuren of afwijzen.",
                    "Terugkoppelen aan systeem."
                ],
                "design": {
                    "components": ["Approval Dashboard", "Notification Service", "Audit Logger"],
                    "dataFlow": ["Policy Engine -> Human -> Approval Status"]
                },
                "prompts": {
                    "research": "Ontwerp workflow voor menselijke goedkeuring.",
                    "build": "Bouw approval dashboard en notificatie integratie (Email/Teams).",
                    "test": "Test user flow van verzoek tot goedkeuring.",
                    "deploy": "Activeer Human-in-the-Loop module."
                }
            },
            "comp-db": {
                "name": "Traceability DB",
                "description": "Slaat alle stappen, prompts en goedkeuringen op voor auditing doeleinden.",
                "steps": [
                    "Loggen van interacties.",
                    "Opslaan van beslissingen en prompts.",
                    "Beschikbaar stellen voor audits."
                ],
                "design": {
                    "components": ["Timeseries DB", "Audit Log Schema", "Query API"],
                    "dataFlow": ["System Components -> Logging -> Database"]
                },
                "prompts": {
                    "research": "Bepaal audit log schema eisen.",
                    "build": "Implementeer structured logging en storage backend.",
                    "test": "Verifieer of events onwijzigbaar worden opgeslagen.",
                    "deploy": "Provision storage en retentie policies."
                }
            },
            "comp-build-plane": {
                "name": "Build Plane",
                "description": "Een Specificatie gestuurde AI omgeving voor het realiseren van een oplossing. Waarbij verschillenden AI-Experts samen werken om een totaal oplossing te realiseren.",
                "steps": [
                    "Ontvangen van bouwspecificatie.",
                    "Genereren van implementatieplan.",
                    "Co√∂rdineren van builders en tools.",
                    "Opleveren van artifacts."
                ],
                "design": {
                    "components": ["Build Controller", "Agent Swarm", "Artifact Repository"],
                    "dataFlow": ["Spec -> Build Controller -> Agents -> Artifacts"]
                },
                "prompts": {
                    "research": "Onderzoek optimale agent samenstelling voor build taken.",
                    "build": "Implementeer multi-agent co√∂rdinatie logica.",
                    "test": "Test generatie snelheid en kwaliteit van output.",
                    "deploy": "Activeer build plane omgeving."
                }
            },
            "comp-builder": {
                "name": "Builder Agent",
                "description": "Gespecialiseerde AI die code en Infrastructure-as-Code (IaC) genereert.",
                "steps": [
                    "Lezen van taakomschrijving.",
                    "Genereren van code (Python, JS, etc.).",
                    "Schrijven van Terraform/Bicep.",
                    "Valideren van syntax."
                ],
                "design": {
                    "components": ["Code LLM", "Syntax Checker", "File Writer"],
                    "dataFlow": ["Task -> LLM -> Code Files"]
                },
                "prompts": {
                    "research": "Selecteer het beste coding LLM model.",
                    "build": "Implementeer code generatie prompts en syntax validatie.",
                    "test": "Genereer unit tests voor gegenereerde code.",
                    "deploy": "Koppel aan Foundry voor build handover."
                }
            },
            "comp-foundry": {
                "name": "Foundry",
                "description": "Standaard IT ontwikkel tools: AI models, Secure Build Pipeline en Testing middelen. Bouwt en test container images en scant op kwetsbaarheden.",
                "steps": [
                    "Pullen van broncode.",
                    "Bouwen van container images.",
                    "Scannen op CVEs (Security).",
                    "Pushen naar registry."
                ],
                "design": {
                    "components": ["CI/CD Pipeline", "Docker Engine", "Vulnerability Scanner"],
                    "dataFlow": ["Code -> Build -> Scan -> Image Registry"]
                },
                "prompts": {
                    "research": "Bepaal security scan tools en container base images.",
                    "build": "Schrijf Dockerfiles en CI/CD pipeline definities.",
                    "test": "Bouw test images en verifieer scanner output.",
                    "deploy": "Configureer build runners en registry access."
                }
            },
            "comp-runtime": {
                "name": "Runtime",
                "description": "Een hardware infrastructuur waarop wij veilig en compliant zonder menselijk tussenkomst snel Bouwblokken kunnen deployen.",
                "steps": [
                    "Ontvangen van deployment manifest.",
                    "Scheduler wijst resources toe.",
                    "Pullen van images.",
                    "Starten van pods."
                ],
                "design": {
                    "components": ["Kubernetes API", "Scheduler", "Kubelet", "Network Policy"],
                    "dataFlow": ["Manifest -> API Server -> Pod Running"]
                },
                "prompts": {
                    "research": "Ontwerp cluster architectuur en netwerk segmentatie.",
                    "build": "Provision kubernetes cluster via Terraform.",
                    "test": "Validatie van failover en scaling behaviour.",
                    "deploy": "Koppel cluster aan CI/CD voor deployments."
                }
            },
            "comp-mcp": {
                "name": "MCP Interface",
                "description": "Een interface waarmee AI toegang kan krijgen tot systemen/data via natuurlijke taal (Model Context Protocol).",
                "steps": [
                    "Vertalen van natuurlijke taal naar API calls.",
                    "Uitvoeren van actie op extern systeem.",
                    "Retourneren van gestructureerd resultaat."
                ],
                "design": {
                    "components": ["MCP Server", "Tool Definitions", "Connection Managers"],
                    "dataFlow": ["AI Call -> MCP -> External System -> Result"]
                },
                "prompts": {
                    "research": "Identificeer te ontsluiten systemen en acties.",
                    "build": "Implementeer MCP server en tool handlers.",
                    "test": "Test tool execution via LLM calls.",
                    "deploy": "Expose MCP endpoint aan Orchestrator."
                }
            },
            "comp-pod-exist": {
                "name": "Knowledge Bot",
                "description": "Bestaande workload die informatie ophaalt uit documenten.",
                "steps": [
                    "Ontvangen van zoekopdracht.",
                    "Embedden van query.",
                    "Retrieveren van chunks.",
                    "Synthetiseren van antwoord."
                ],
                "design": {
                    "components": ["Vector DB Client", "Embedding Model", "Response Generator"],
                    "dataFlow": ["Query -> Vector Search -> Context -> Answer"]
                },
                "prompts": {
                    "research": "Selecteer embedding model en vector database.",
                    "build": "Bouw ingest pipeline en RAG retrieval logica.",
                    "test": "Meet retrieval accuracy op test queries.",
                    "deploy": "Deploy pod en start indexering."
                }
            },
            "comp-new-pod": {
                "name": "Dynamic Slot",
                "description": "Ruimte voor nieuwe applicaties die door de Builder Agent worden gedeployed.",
                "steps": [
                    "Reserveren van resources.",
                    "Deployen van nieuwe container.",
                    "Configureren van netwerk toegang."
                ],
                "design": {
                    "components": ["Namespace", "Resource Quota", "Ingress"],
                    "dataFlow": ["Deployment -> New Pod -> Active Service"]
                },
                "prompts": {
                    "research": "Bepaal resource requirements voor nieuwe container workloads.",
                    "build": "Genereer Kubernetes Deployment en Service manifests.",
                    "test": "Simuleer deployment en verifieer health probes.",
                    "deploy": "Apply manifests naar namespace en verifieer rollout status."
                }
            }
        };
    </script>
    <!-- TOP NAV -->
    <nav class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-lg z-50 flex-none h-14">
        <div class="flex items-center space-x-3">
            <div class="h-8 w-8 bg-blue-600 rounded flex items-center justify-center font-bold">AI</div>
            <div>
                <h1 class="text-sm font-bold">Druppie</h1>
                <p class="text-[10px] text-slate-400">Spec-Driven & Human-in-the-Loop</p>
            </div>
        </div>
        <div class="flex space-x-3" id="top-nav-actions">
            <!-- Scenario 1 Button -->
            <button onclick="runScenario('response')"
                class="group px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded border border-slate-600 transition flex items-center space-x-2">
                <div class="w-2 h-2 rounded-full bg-green-400 group-hover:animate-ping"></div>
                <div class="text-left">
                    <div class="text-[9px] text-slate-400 uppercase font-bold">Scenario 1</div>
                    <div class="text-xs font-bold">Vraag & Antwoord</div>
                </div>
            </button>

            <!-- Scenario 2 Button -->
            <button onclick="runScenario('build')"
                class="group px-3 py-1.5 bg-indigo-900 hover:bg-indigo-800 rounded border border-indigo-700 transition flex items-center space-x-2">
                <div class="w-2 h-2 rounded-full bg-orange-400 group-hover:animate-ping"></div>
                <div class="text-left">
                    <div class="text-[9px] text-indigo-300 uppercase font-bold">Scenario 2 (HITL)</div>
                    <div class="text-xs font-bold">Bouwen & Goedkeuring</div>
                </div>
            </button>
        </div>
    </nav>

    <div class="flex flex-grow overflow-hidden">

        <div class="flex flex-grow overflow-hidden relative">

            <!-- SIDEBAR -->
            <div class="w-64 bg-slate-800 text-white flex flex-col flex-none shadow-xl z-50 transition-all duration-300 transform"
                id="sidebar">
                <div class="p-4 border-b border-slate-700">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Navigatie</h2>
                </div>
                <div class="flex-grow overflow-y-auto py-2">
                    <nav class="space-y-1 px-2">
                        <button onclick="navTo('arch')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-blue-400 transition-colors">
                            <i data-lucide="layout-dashboard" class="inline-block w-4 h-4 mr-2"></i> Overall
                            Architectuur
                        </button>

                        <div class="pt-4 pb-1 px-3 text-[10px] font-bold text-slate-500 uppercase">Specificaties</div>

                        <!-- Bouwblokken -->
                        <button onclick="navTo('dir', 'bouwblokken')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="package" class="inline-block w-4 h-4 mr-2"></i> Bouwblokken
                        </button>

                        <!-- Skills -->
                        <button onclick="navTo('dir', 'skills')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="zap" class="inline-block w-4 h-4 mr-2"></i> Skills
                        </button>

                        <!-- Build Plane -->
                        <button onclick="navTo('dir', 'build_plane')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="hammer" class="inline-block w-4 h-4 mr-2"></i> Build Plane
                        </button>

                        <!-- Runtime -->
                        <button onclick="navTo('dir', 'runtime')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="server" class="inline-block w-4 h-4 mr-2"></i> Runtime
                        </button>

                        <!-- Compliance -->
                        <button onclick="navTo('dir', 'compliance')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="shield" class="inline-block w-4 h-4 mr-2"></i> Compliance
                        </button>

                        <!-- Top Level Readme -->
                        <button onclick="navTo('dir', 'general')"
                            class="w-full text-left px-3 py-2 rounded text-sm font-medium hover:bg-slate-700 text-slate-300 transition-colors border-t border-slate-700 mt-2 pt-2">
                            <i data-lucide="file-text" class="inline-block w-4 h-4 mr-2"></i> Project Readme
                        </button>
                    </nav>
                </div>

                <!-- File System Indicator -->
                <div id="fs-indicator" class="p-4 bg-slate-900 text-xs text-slate-500 border-t border-slate-700">
                    Detecting environment...
                </div>
                <!-- Local Access Button -->
                <div id="local-access-ui" class="hidden px-4 pb-4 bg-slate-900 border-t border-slate-800 pt-2">
                    <button onclick="startLocalSession()"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded flex items-center justify-center">
                        <i data-lucide="folder-open" class="w-3 h-3 mr-2"></i> Open Project Folder
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2 leading-tight">Click to enable Read/Write access to local
                        files.</p>
                </div>
            </div>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-grow flex flex-col relative overflow-hidden bg-slate-50 min-w-0">

                <!-- VIEW: ARCHITECTURE (Original Content) -->
                <div id="view-arch" class="flex flex-col h-full overflow-hidden">

                    <!-- KANBAN BOARD -->
                    <div class="p-4 border-b border-slate-200">
                        <div class="kanban-container">
                            <div class="kanban-col" id="col-backlog">
                                <div class="kanban-header">1. Aanvraag</div>
                            </div>
                            <div class="kanban-col" id="col-spec">
                                <div class="kanban-header">2. Specificatie</div>
                            </div>
                            <div class="kanban-col" id="col-approval">
                                <div class="kanban-header">3. Goedkeuring</div>
                            </div>
                            <div class="kanban-col" id="col-exec">
                                <div class="kanban-header">4. Uitvoering</div>
                            </div>

                            <!-- Split Column 5 -->
                            <div class="kanban-col" style="padding: 2px; background: #e2e8f0;">
                                <div class="kanban-header" style="margin-left: 4px; margin-top: 4px;">5. Output</div>
                                <div class="split-container">
                                    <div class="split-col" id="col-response">
                                        <div class="split-label">Antwoord</div>
                                    </div>
                                    <div class="split-col" id="col-live">
                                        <div class="split-label text-green-700">Live App</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SPLIT ROW: DIAGRAM + INSPECTOR -->
                    <div class="flex-grow flex overflow-hidden relative">

                        <!-- ARCHITECTURE DIAGRAM -->
                        <div class="p-6 flex-grow relative flex flex-col justify-center overflow-auto"
                            id="diagram-area">
                            <!-- Background Grid -->
                            <div class="absolute inset-0 opacity-[0.05] pointer-events-none"
                                style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;">
                            </div>

                            <div class="diagram-grid max-w-5xl mx-auto w-full select-none">

                                <!-- DRUPPIE COMPLIANCE WRAPPER (Background Layer) -->
                                <div id="comp-compliance" onclick="inspect('comp-compliance')"
                                    class="absolute -inset-8 bg-red-50/40 ml-2 mr-2 border-2 border-dashed border-red-200 rounded-[3rem] z-0 cursor-pointer hover:bg-red-50/60 transition-colors shadow-sm">
                                    <div
                                        class="absolute bottom-2 right-6 flex items-center gap-2 text-red-300 font-bold uppercase tracking-widest text-[10px]">
                                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                                        Druppie Compliance Layer
                                    </div>
                                </div>

                                <!-- TOP: USER -->
                                <div class="col-span-12 flex justify-center mb-6 z-10">
                                    <div id="comp-copilot" onclick="inspect('comp-copilot')"
                                        class="arch-card w-1/3 text-center border-t-4 border-t-blue-500 shadow-sm">
                                        <div class="text-3xl mb-1">üë§</div>
                                        <div class="font-bold text-sm">Druppie APP<BR>Copilot APP</div>
                                        <div class="text-[10px] text-slate-400">Gebruiker Interface</div>
                                    </div>
                                </div>

                                <!-- MIDDLE: CONTROL PLANE -->
                                <div class="col-span-12 grid grid-cols-12 gap-4 mb-8 z-10">

                                    <!-- NEW SPLIT COLUMN: Bouwblokken & Entra -->
                                    <div class="col-span-2 flex flex-col gap-2 h-full">
                                        <!-- Bouwblok Definities -->
                                        <div id="comp-blocks" onclick="inspect('comp-blocks')"
                                            class="arch-card flex-1 text-center bg-indigo-50/50 border-indigo-200 flex flex-col justify-center hover:bg-indigo-50 transition">
                                            <div class="text-xl">üß©</div>
                                            <div class="text-[9px] font-bold mt-1 leading-tight">Bouwblok<br>Definities
                                            </div>
                                        </div>

                                        <!-- Entra ID -->
                                        <div id="comp-entra" onclick="inspect('comp-entra')"
                                            class="arch-card flex-1 text-center bg-slate-50 flex flex-col justify-center">
                                            <div class="text-xl">üõ°Ô∏è</div>
                                            <div class="text-[9px] font-bold mt-1">IAM</div>
                                        </div>
                                    </div>

                                    <!-- Orchestrator (X-Ray) -->
                                    <div id="comp-orch" onclick="inspect('comp-orch')"
                                        class="col-span-6 arch-card bg-blue-600 text-white shadow-lg p-3">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h3 class="font-bold text-xs">Druppie Core</h3>
                                                <p class="text-[9px] text-blue-200">Semantic Kernel</p>
                                            </div>
                                            <span class="text-2xl">üß†</span>
                                        </div>
                                        <!-- Bouwblokken van de Agent -->
                                        <div class="grid grid-cols-2 gap-2">
                                            <div id="inner-planner" class="internal-block">Planner (Logic)</div>
                                            <div id="inner-memory" class="internal-block">Memory (Context)</div>
                                            <div id="inner-rag" class="internal-block">RAG (Knowledge)</div>
                                            <div id="inner-safety"
                                                class="internal-block bg-red-500/20 border-red-400/50">
                                                Safety
                                                Filter</div>
                                        </div>
                                    </div>

                                    <!-- Governance & Approval -->
                                    <div class="col-span-4 grid grid-cols-1 gap-2 h-full">
                                        <div class="flex gap-2 h-full">
                                            <div id="comp-policy" onclick="inspect('comp-policy')"
                                                class="arch-card flex-1 text-center bg-slate-50 flex flex-col justify-center">
                                                <div class="text-lg">üìú</div>
                                                <div class="text-[9px] font-bold">Policy</div>
                                            </div>
                                            <!-- THE CISO COMPONENT -->
                                            <div id="comp-ciso" onclick="inspect('comp-ciso')"
                                                class="arch-card flex-1 text-center border-purple-300 bg-purple-50 flex flex-col justify-center relative transition-all duration-300">
                                                <div class="absolute -top-2 -right-2 bg-red-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-sm"
                                                    id="ciso-badge">REQ</div>
                                                <div class="text-lg">üëÆ‚Äç‚ôÇÔ∏è</div>
                                                <div class="text-[9px] font-bold text-purple-900">Mens in Loop</div>
                                                <div id="ciso-status" class="text-[8px] text-slate-400 mt-1">Idle</div>
                                            </div>
                                        </div>
                                        <div id="comp-db" onclick="inspect('comp-db')"
                                            class="arch-card text-center bg-teal-50 border-teal-300 py-2">
                                            <div class="text-xs font-bold text-teal-800">üóÑÔ∏è Traceability & Audit DB
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- BOTTOM: EXECUTION PLANES (Parallel) -->
                                <div class="col-span-12 grid grid-cols-2 gap-6 z-10">

                                    <!-- Build Plane -->
                                    <div
                                        class="border-2 dashed border-orange-200 rounded-xl p-3 bg-orange-50/30 relative">
                                        <span id="comp-build-plane" onclick="inspect('comp-build-plane')"
                                            class="absolute -top-3 left-4 bg-orange-100 text-orange-600 text-[9px] font-bold px-2 rounded uppercase tracking-wider">Build
                                            Plane</span>
                                        <div class="flex space-x-2 items-center h-full">
                                            <div id="comp-builder" onclick="inspect('comp-builder')"
                                                class="arch-card flex-1 text-center border-orange-300 py-3">
                                                <div class="text-xl">üë∑‚Äç‚ôÇÔ∏è</div>
                                                <div class="font-bold text-[10px] text-orange-900">Builder Agent</div>
                                            </div>
                                            <div class="text-orange-300 text-xs">‚ûî</div>
                                            <div id="comp-foundry" onclick="inspect('comp-foundry')"
                                                class="arch-card flex-1 text-center border-orange-300 opacity-60 py-3">
                                                <div class="text-xl">üè≠</div>
                                                <div class="font-bold text-[10px]">Foundry</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Runtime Plane -->
                                    <div
                                        class="border-2 dashed border-green-200 rounded-xl p-3 bg-green-50/30 relative">
                                        <span id="comp-runtime" onclick="inspect('comp-runtime')"
                                            class="absolute -top-3 left-4 bg-green-100 text-green-600 text-[9px] font-bold px-2 rounded uppercase tracking-wider">Runtime</span>
                                        <div class="flex flex-col h-full justify-between gap-2">
                                            <div id="comp-mcp" onclick="inspect('comp-mcp')"
                                                class="bg-slate-800 text-white rounded p-1 text-center text-[9px] font-mono">
                                                &lt; MCP Interface /&gt;
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div id="comp-pod-exist" onclick="inspect('comp-pod-exist')"
                                                    class="bg-white border border-green-200 rounded p-2 text-center opacity-60 cursor-pointer hover:shadow-md transition">
                                                    <div class="text-sm">üìö</div>
                                                    <div class="text-[8px]">Kennis Bot</div>
                                                </div>
                                                <div id="comp-new-pod" onclick="inspect('comp-new-pod')"
                                                    class="bg-transparent border-2 dashed border-slate-300 rounded p-2 text-center flex flex-col items-center justify-center min-h-[50px] cursor-pointer hover:border-slate-400 transition">
                                                    <span class="text-[8px] text-slate-400">Empty Slot</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>

                            <!-- Animation Layer -->
                            <div id="anim-layer" class="absolute inset-0 pointer-events-none w-full h-full z-50"></div>
                        </div>

                        <!-- RIGHT: ENHANCED SIDEBAR (Split View) -->
                        <div class="w-96 bg-white border-l border-slate-200 flex flex-col shadow-2xl z-40 flex-none">

                            <!-- 1. COMPONENT INSPECTOR -->
                            <div class="h-1/3 border-b border-slate-200 bg-slate-50 flex flex-col">
                                <div class="p-3 border-b border-slate-200 bg-white flex justify-between items-center">
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-wider text-slate-500 flex items-center gap-2">
                                        <i data-lucide="mouse-pointer-2" class="w-3 h-3"></i> Inspecteur
                                    </span>
                                    <span class="text-[9px] text-slate-400" id="insp-header-status">Selecteer een
                                        component</span>
                                    <div id="insp-header-active-status" class="hidden flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                        <span class="text-[9px] font-mono text-green-700 font-bold">Active</span>
                                    </div>
                                </div>
                                <div id="inspector-content" class="p-4 flex-1 overflow-y-auto">
                                    <!-- Default State -->
                                    <div id="insp-default"
                                        class="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
                                        <i data-lucide="box-select" class="w-8 h-8 mb-2"></i>
                                        <span class="text-xs">Klik op diagram voor details</span>
                                    </div>
                                    <!-- Active State (Hidden by default) -->
                                    <div id="insp-active" class="hidden space-y-3">
                                        <div>
                                            <span
                                                class="text-[10px] text-slate-400 uppercase font-bold">Component</span>
                                            <div id="insp-title" class="text-sm font-bold text-slate-800">...</div>
                                        </div>
                                        <div>
                                            <span
                                                class="text-[10px] text-slate-400 uppercase font-bold">Beschrijving</span>
                                            <p id="insp-desc" class="text-xs text-slate-600 leading-relaxed mt-1">...
                                            </p>
                                        </div>


                                        <div id="insp-spec-container"
                                            class="hidden pt-2 border-t border-slate-200 mt-2">
                                            <span class="text-[10px] text-slate-400 uppercase font-bold">Spec
                                                Context</span>
                                            <p id="insp-spec-desc"
                                                class="text-xs text-indigo-600 leading-relaxed mt-1 italic">
                                                ...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. CHAT INTERFACE -->
                            <div class="flex-1 flex flex-col min-h-0 border-b border-slate-200 bg-white relative">
                                <div
                                    class="p-2 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-wider text-slate-500 flex items-center gap-2">
                                        <i data-lucide="message-square" class="w-3 h-3"></i> Conversatie
                                    </span>
                                    <div id="status-indicator"
                                        class="text-[9px] font-bold text-slate-400 flex items-center">
                                        <span class="w-1.5 h-1.5 bg-slate-300 rounded-full mr-1.5"></span> Gereed
                                    </div>
                                </div>
                                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                                    <div class="text-center text-slate-300 text-[10px] italic mt-4">Start een
                                        scenario...
                                    </div>
                                </div>
                            </div>

                            <!-- 3. BUILD TERMINAL -->
                            <div class="h-48 bg-slate-900 flex flex-col">
                                <div
                                    class="h-7 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-3">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                        <i data-lucide="terminal" class="w-3 h-3"></i> Build Terminal
                                    </span>
                                    <div class="flex gap-1.5">
                                        <div class="w-2 h-2 rounded-full bg-slate-600"></div>
                                        <div class="w-2 h-2 rounded-full bg-slate-600"></div>
                                    </div>
                                </div>
                                <div id="terminal-output"
                                    class="flex-1 p-3 overflow-y-auto font-mono text-[10px] text-slate-300 dark-scroll">
                                    <div class="terminal-line term-info">> System initialized. Waiting for input...
                                    </div>
                                </div>
                            </div>

                        </div>



                    </div> <!-- End Split Row -->

                </div> <!-- End view-arch -->

                <script>
                    // Init Icons
                    lucide.createIcons();

                    // --- UTILS ---
                    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

                    let currentScenarioKey = null;

                    // --- COMPONENT TO DOC MAPPING ---
                    const COMP_TO_DOC = {
                        "comp-copilot": "bouwblokken/druppie_ui.md",
                        "comp-blocks": "bouwblokken/bouwblok_definities.md",
                        "comp-entra": "compliance/iam.md",
                        "comp-orch": "bouwblokken/druppie_core.md",
                        "comp-policy": "bouwblokken/policy_engine.md",
                        "comp-ciso": "bouwblokken/mens_in_de_loop.md",
                        "comp-db": "bouwblokken/traceability_db.md",
                        "comp-build-plane": "bouwblokken/build_plane.md",
                        "comp-builder": "build_plane/builder_agent.md",
                        "comp-foundry": "build_plane/foundry.md",
                        "comp-runtime": "bouwblokken/runtime.md",
                        "comp-mcp": "runtime/mcp_interface.md",
                        "comp-pod-exist": "bouwblokken/knowledge_bot.md",
                        "comp-new-pod": "runtime/dynamic_slot.md",
                        "comp-compliance": "bouwblokken/compliance_layer.md"
                    };

                    function openComponentDoc(id) {
                        const path = COMP_TO_DOC[id];
                        if (!path) return;
                        const category = path.split('/')[0];
                        navTo('dir', category);
                        if (DOC_REGISTRY[category]) {
                            const idx = DOC_REGISTRY[category].findIndex(d => d.path === path);
                            if (idx !== -1) selectDoc(idx);
                            else loadMarkdown(path);
                        }
                    }

                    // --- INSPECTOR LOGIC ---
                    function inspect(id) {
                        const data = SPEC[id];

                        // If checking compliance, highlight red, otherwise blue
                        const color = id === 'comp-compliance' ? 'red' : 'blue';
                        highlight(id, color);

                        if (!data && !currentScenarioKey) return;

                        document.getElementById('insp-default').classList.add('hidden');
                        document.getElementById('insp-active').classList.remove('hidden');

                        const specContainer = document.getElementById('insp-spec-container');
                        const specDesc = document.getElementById('insp-spec-desc');
                        const titleEl = document.getElementById('insp-title');
                        const descEl = document.getElementById('insp-desc');

                        specContainer.classList.add('hidden');
                        specDesc.innerHTML = '';

                        // 1. Direct SPEC match (Component)
                        if (data) {
                            // Populate Main Header with Name/Description
                            const existingBtn = document.getElementById('btn-open-comp-doc');
                            if (existingBtn) existingBtn.remove();

                            titleEl.innerHTML = `<span>${data.name}</span>`;

                            if (COMP_TO_DOC[id]) {
                                const btn = document.createElement('button');
                                btn.id = 'btn-open-comp-doc';
                                btn.className = 'ml-2 px-2 py-0.5 bg-blue-100 hover:bg-blue-200 text-blue-700 text-[9px] rounded uppercase font-bold tracking-wider inline-flex items-center gap-1 transition';
                                btn.innerHTML = '<i data-lucide="external-link" class="w-3 h-3"></i> Doc';
                                btn.onclick = (e) => {
                                    e.stopPropagation();
                                    openComponentDoc(id);
                                };
                                titleEl.appendChild(btn);
                                lucide.createIcons();
                            }

                            descEl.innerText = data.description;

                            // Show Extra Spec Details
                            specContainer.classList.remove('hidden');

                            let html = '';

                            // Steps
                            if (data.steps) {
                                html += `<div class="text-[9px] uppercase font-bold text-slate-400 mt-2 mb-1">Stappen</div>`;
                                html += `<ul class="list-disc list-inside space-y-0.5 pl-1 opacity-80">`;
                                data.steps.forEach(s => html += `<li>${s}</li>`);
                                html += `</ul>`;
                            }

                            // Design Components
                            if (data.design && data.design.components) {
                                html += `<div class="text-[9px] uppercase font-bold text-slate-400 mt-3 mb-1">Design Componenten</div>`;
                                html += `<div class="flex flex-wrap gap-1">`;
                                data.design.components.forEach(c => {
                                    let name = typeof c === 'string' ? c : c.name;
                                    html += `<span class="px-1.5 py-0.5 bg-indigo-50 text-indigo-700 rounded border border-indigo-100">${name}</span>`;
                                });
                                html += `</div>`;
                            }

                            // Data Flow
                            if (data.design && data.design.dataFlow) {
                                html += `<div class="text-[9px] uppercase font-bold text-slate-400 mt-3 mb-1">Data Flow</div>`;
                                html += `<div class="p-2 bg-slate-50 border border-slate-100 rounded text-[9px] font-mono text-slate-600 leading-relaxed">`;
                                data.design.dataFlow.forEach(flow => html += `<div>${flow}</div>`);
                                html += `</div>`;
                            }

                            // Prompts
                            if (data.prompts) {
                                html += `<div class="text-[9px] uppercase font-bold text-slate-400 mt-3 mb-1">Prompts (Lifecycle)</div>`;
                                html += `<div class="space-y-1">`;
                                for (const [key, value] of Object.entries(data.prompts)) {
                                    html += `
                            <div class="border border-slate-100 rounded bg-indigo-50/30 p-1.5">
                                <div class="text-[8px] uppercase font-bold text-indigo-500 mb-0.5">${key}</div>
                                <div class="text-[9px] text-slate-600 italic leading-snug">"${value}"</div>
                            </div>
                         `;
                                }
                                html += `</div>`;
                            }

                            specDesc.innerHTML = html;
                        }
                        // 2. Fallback: Component lookup within active scenario
                        else if (currentScenarioKey && SPEC[currentScenarioKey]) {
                            const comps = SPEC[currentScenarioKey].design.components;
                            // Try to find a match? We don't have title argument anymore.
                            // Best effort: if we don't have ID match, we can't do much without the title arg.
                            // However, user said "remove redundant data". 
                            // All interactive components SHOULD have an ID and a SPEC entry now.
                            // So this fallback might be obsolete if I did my job right in Step 101.
                        }

                        // Toggle Header Status
                        const headerStatus = document.getElementById('insp-header-status');
                        const headerActive = document.getElementById('insp-header-active-status');
                        if (headerStatus && headerActive) {
                            headerStatus.classList.add('hidden');
                            headerActive.classList.remove('hidden');
                        }
                    }

                    // Helper to reset header status when resetting
                    function resetInspectorHeader() {
                        const headerStatus = document.getElementById('insp-header-status');
                        const headerActive = document.getElementById('insp-header-active-status');
                        if (headerStatus && headerActive) {
                            headerStatus.classList.remove('hidden');
                            headerActive.classList.add('hidden');
                        }
                    }

                    // --- LOGGING LOGIC ---
                    function setStatus(text, type = 'neutral') {
                        const el = document.getElementById('status-indicator');
                        let color = 'bg-slate-400';
                        if (type === 'active') color = 'bg-blue-500 animate-pulse';
                        if (type === 'waiting') color = 'bg-purple-500 animate-bounce';
                        if (type === 'success') color = 'bg-green-500';

                        el.innerHTML = `<span class="w-1.5 h-1.5 ${color} rounded-full mr-1.5"></span> ${text}`;
                    }

                    function logChat(role, text) {
                        const container = document.getElementById('chat-container');
                        if (container.querySelector('.text-center')) container.innerHTML = '';

                        const wrapper = document.createElement('div');
                        wrapper.className = `flex gap-2 w-full ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                        let icon = role === 'user'
                            ? `<div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center shrink-0 order-2 text-blue-600"><i data-lucide="user" class="w-3 h-3"></i></div>`
                            : role === 'loop-user' ? `<div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 text-indigo-600"><i data-lucide="message-circle-question-mark" class="w-3 h-3"></i></div>`
                                : `<div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 text-indigo-600"><i data-lucide="bot" class="w-3 h-3"></i></div>`;

                        let bubbleClass = role === 'user' ? 'bubble-user' : role === 'loop-user' ? 'loop-user' : 'bubble-ai';

                        wrapper.innerHTML = `
                ${role === 'ai' || role === 'loop-user' ? icon : ''}
                <div class="chat-bubble ${bubbleClass}">
                    ${text}
                </div>
                ${role === 'user' ? icon : ''}
            `;

                        container.appendChild(wrapper);
                        container.scrollTop = container.scrollHeight;
                        lucide.createIcons(); // Refresh icons in new content
                    }

                    function logTerminal(text, type = 'info') {
                        const term = document.getElementById('terminal-output');
                        const line = document.createElement('div');

                        let colorClass = 'term-info';
                        let prefix = 'INFO';

                        if (type === 'success') { colorClass = 'term-success'; prefix = 'OK'; }
                        if (type === 'warn') { colorClass = 'term-warn'; prefix = 'WARN'; }
                        if (type === 'error') { colorClass = 'term-error'; prefix = 'ERR'; }

                        // Get timestamp
                        const now = new Date();
                        const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

                        line.className = `terminal-line ${colorClass}`;
                        line.innerHTML = `<span class="opacity-50">[${time}]</span> <span class="font-bold">[${prefix}]</span> ${text}`;

                        term.appendChild(line);
                        term.scrollTop = term.scrollHeight;
                    }

                    // --- GRAPHICS & RESET ---
                    function resetSimulation() {
                        // Reset Kanban
                        document.querySelectorAll('.project-card').forEach(el => el.remove());

                        // Reset Chat & Terminal
                        document.getElementById('chat-container').innerHTML = '';
                        // Don't clear terminal completely, just add a separator
                        logTerminal('--- New Session Started ---', 'info');

                        // Reset Diagram styles
                        document.querySelectorAll('.arch-card').forEach(el => el.classList.remove('active-comp', 'ring-blue', 'ring-purple', 'ring-orange', 'ring-green'));
                        document.querySelectorAll('.internal-block').forEach(el => el.classList.remove('internal-active'));
                        // Remove compliance highlight
                        document.getElementById('comp-compliance').classList.remove('ring-red', 'active-comp');


                        // Reset CISO
                        document.getElementById('ciso-badge').classList.add('hidden');
                        document.getElementById('comp-ciso').classList.remove('pulse-req');
                        document.getElementById('ciso-status').innerText = 'Idle';
                        document.getElementById('ciso-status').className = 'text-[8px] text-slate-400 mt-1';

                        // Reset Pod
                        const pod = document.getElementById('comp-new-pod');
                        pod.className = "bg-transparent border-2 dashed border-slate-300 rounded p-2 text-center flex flex-col items-center justify-center min-h-[50px] cursor-pointer hover:border-slate-400 transition";
                        pod.innerHTML = '<span class="text-[8px] text-slate-400">Empty Slot</span>';

                        // Reset Opacity
                        document.getElementById('comp-foundry').classList.add('opacity-60');

                        setStatus("Simulatie Reset", "neutral");

                        // Reset Inspector
                        document.getElementById('insp-default').classList.remove('hidden');
                        document.getElementById('insp-active').classList.add('hidden');
                        document.getElementById('insp-spec-container').classList.add('hidden');
                        resetInspectorHeader();
                        currentScenarioKey = null;
                    }

                    function addCard(title) {
                        const card = document.createElement('div');
                        card.id = 'active-card';
                        card.className = 'project-card';
                        card.innerText = title;
                        document.getElementById('col-backlog').appendChild(card);
                    }

                    function moveCard(colId) {
                        const card = document.getElementById('active-card');
                        const target = document.getElementById(colId);
                        if (card && target) target.appendChild(card);
                    }

                    function highlight(id, color = 'blue', internal = false) {
                        const el = document.getElementById(id);
                        if (!el) return;

                        // Remove previous highlights
                        document.querySelectorAll('.arch-card').forEach(c => c.classList.remove('active-comp', 'ring-blue', 'ring-purple', 'ring-orange', 'ring-green'));
                        document.querySelectorAll('.internal-block').forEach(c => c.classList.remove('internal-active'));

                        // Remove compliance ring explicitly if clicking something else
                        if (id !== 'comp-compliance') {
                            document.getElementById('comp-compliance').classList.remove('ring-red', 'active-comp');
                        }

                        if (internal) {
                            el.classList.add('internal-active');
                            document.getElementById('comp-orch').classList.add('ring-blue');
                        } else {
                            el.classList.add('active-comp');
                            if (color === 'blue') el.classList.add('ring-blue');
                            if (color === 'purple') el.classList.add('ring-purple');
                            if (color === 'orange') el.classList.add('ring-orange');
                            if (color === 'green') el.classList.add('ring-green');
                            if (color === 'red') el.classList.add('ring-red');
                        }
                    }

                    function sendPacket(from, to, color = '#3b82f6', speed = 1200) {
                        return new Promise((resolve) => {
                            const elFrom = document.getElementById(from);
                            const elTo = document.getElementById(to);
                            const area = document.getElementById('diagram-area');

                            if (!elFrom || !elTo || !area) {
                                resolve();
                                return;
                            }

                            const f = elFrom.getBoundingClientRect();
                            const t = elTo.getBoundingClientRect();
                            const a = area.getBoundingClientRect();

                            const pkt = document.createElement('div');
                            pkt.className = 'packet';
                            pkt.style.backgroundColor = color;
                            document.getElementById('anim-layer').appendChild(pkt);

                            const startX = f.left - a.left + f.width / 2;
                            const startY = f.top - a.top + f.height / 2;
                            const endX = t.left - a.left + t.width / 2;
                            const endY = t.top - a.top + t.height / 2;

                            const anim = pkt.animate([
                                { left: startX + 'px', top: startY + 'px', opacity: 1 },
                                { left: endX + 'px', top: endY + 'px', opacity: 1 },
                                { opacity: 0 }
                            ], { duration: speed, easing: 'ease-in-out' });

                            anim.onfinish = () => {
                                pkt.remove();
                                resolve();
                            };
                        });
                    }

                    // --- SCENARIOS ---

                    async function runScenario(type) {
                        resetSimulation();
                        currentScenarioKey = type;
                        await sleep(800);

                        // --- SCENARIO 1: RESPONSE ONLY ---
                        if (type === 'response') {
                            addCard("Vraag: HR Beleid");
                            setStatus("Scenario 1: Vraag Verwerking", "active");

                            // 1. Request
                            logChat('user', "Wat is het thuiswerkbeleid?");
                            logTerminal("Received prompt via Copilot Interface", "info");
                            highlight('comp-copilot');
                            await sleep(1000);

                            await sendPacket('comp-copilot', 'comp-orch');

                            // 2. Orchestration
                            moveCard('col-spec');

                            // NEW: CHECK BUILDING BLOCKS
                            highlight('comp-blocks', 'blue');
                            logTerminal("Registry: Checking for existing capabilities...", "info");
                            await sleep(800);

                            highlight('inner-planner', 'blue', true);
                            logTerminal("Semantic Kernel: Planning step invoked", "info");
                            logTerminal("Planner detected intent: 'InformationRetrieval'", "success");
                            await sleep(1500);

                            highlight('inner-rag', 'blue', true);
                            logTerminal("RAG: Querying Vector DB for 'homework policy'...", "info");
                            await sleep(1000);

                            // 3. Execution
                            moveCard('col-exec');
                            logTerminal("Orchestrator: Routing payload to Knowledge Bot", "info");
                            await sendPacket('comp-orch', 'comp-pod-exist', '#22c55e');
                            highlight('comp-pod-exist', 'green');
                            await sleep(1000);

                            // 4. Response
                            moveCard('col-response');
                            await sendPacket('comp-pod-exist', 'comp-copilot', '#22c55e');
                            highlight('comp-copilot');
                            logTerminal("Response generation completed", "success");
                            logChat('ai', "Het beleid staat 2 dagen thuiswerken toe, in overleg met je manager.");
                            setStatus("Scenario 1 Voltooid.", "success");
                        }

                        // --- SCENARIO 2: BUILD + APPROVAL ---
                        if (type === 'build') {
                            addCard("Project: Sales Bot");
                            setStatus("Scenario 2: Bouw + Goedkeuring", "active");

                            // 1. Request
                            logChat('user', "Bouw een Sales Tool met directe SQL toegang.");
                            logTerminal("Received prompt via Copilot Interface", "info");
                            highlight('comp-copilot');
                            await sleep(1500);
                            await sendPacket('comp-copilot', 'comp-orch');

                            // 2. Spec & Policy Check
                            moveCard('col-spec');

                            // NEW: CHECK BUILDING BLOCKS
                            highlight('comp-blocks', 'blue');
                            logTerminal("Registry: No matching skill found for SQL Sales access.", "info");
                            await sleep(800);

                            highlight('inner-planner', 'blue', true);
                            logTerminal("Planner: Detected intent 'NewApplicationScaffold'", "success");
                            await sleep(1500);

                            highlight('inner-safety', 'blue', true);
                            logTerminal("Safety Filter: Analyzing constraints...", "info");
                            logTerminal("ALERT: High-risk resource request (SQL Direct Access)", "warn");
                            await sleep(1000);

                            await sendPacket('comp-orch', 'comp-policy');
                            highlight('comp-policy');
                            logTerminal("Policy Engine: Rule violation found. Escalating to CISO.", "warn");

                            // 3. Approval (CISO)
                            moveCard('col-approval');
                            await sendPacket('comp-policy', 'comp-ciso', '#9333ea');

                            // CISO STATE
                            highlight('comp-ciso', 'purple');
                            document.getElementById('comp-ciso').classList.add('pulse-req');
                            document.getElementById('ciso-badge').classList.remove('hidden');
                            document.getElementById('ciso-status').innerText = 'Wachten op actie...';
                            document.getElementById('ciso-status').className = 'text-[8px] text-red-500 font-bold mt-1';

                            setStatus("Wachten op CISO...", "waiting");
                            logTerminal("PROCESS SUSPENDED: Awaiting manual approval ticket #8842", "warn");
                            logChat('loop-user', "Ik heb goedkeuring nodig voor SQL toegang. Een verzoek is verstuurd naar Security.");

                            // Simulate Wait time
                            await sleep(3000);

                            // CISO APPROVED
                            document.getElementById('comp-ciso').classList.remove('pulse-req');
                            document.getElementById('ciso-badge').classList.add('hidden');
                            document.getElementById('ciso-status').innerText = 'APPROVED';
                            document.getElementById('ciso-status').className = 'text-[8px] text-green-600 font-bold mt-1';
                            logTerminal("CISO Gate: Ticket #8842 Approved by admin", "success");
                            logChat('ai', "Ik heb goedkeuring gekregen voor SQL toegang.");


                            // 4. Traceability
                            await sendPacket('comp-ciso', 'comp-db', '#22c55e');
                            highlight('comp-db', 'green');
                            logTerminal("Audit DB: Transaction logged.", "info");
                            await sleep(1000);

                            // 5. Build
                            moveCard('col-exec');
                            setStatus("Bouw gestart...", "active");
                            await sendPacket('comp-db', 'comp-builder', '#f97316');
                            highlight('comp-builder', 'orange');
                            logTerminal("Builder Agent: Generating Terraform & Python code...", "info");
                            await sleep(2000);

                            await sendPacket('comp-builder', 'comp-foundry', '#f97316');
                            highlight('comp-foundry', 'orange');
                            document.getElementById('comp-foundry').classList.remove('opacity-60');
                            logTerminal("Foundry: Docker build started...", "info");
                            logTerminal("Foundry: Scanning image for CVEs... OK", "success");
                            await sleep(2000);

                            // 6. Deploy
                            await sendPacket('comp-foundry', 'comp-new-pod', '#22c55e');

                            const pod = document.getElementById('comp-new-pod');
                            pod.className = "bg-green-100 border border-green-500 rounded p-1 text-center flex flex-col items-center justify-center min-h-[50px] cursor-pointer hover:shadow-md transition";
                            pod.innerHTML = '<div class="text-xs">üìà</div><div class="text-[8px] font-bold text-green-800">Sales Bot</div>';
                            highlight('comp-new-pod', 'green');

                            moveCard('col-live');
                            logTerminal("Runtime: Pod 'sales-bot-v1' scheduled and running", "success");
                            logChat('ai', "De Sales Tool is gebouwd, beveiligd en staat nu live.");
                            setStatus("Scenario 2 Succesvol Voltooid.", "success");
                        }
                    }
                </script>
            </div> <!-- End view-arch -->



            <!-- VIEW: MARKDOWN READER (Split View) -->
            <div id="view-markdown" class="hidden flex-row h-full overflow-hidden absolute inset-0 bg-white z-30 ml-64">

                <!-- LEFT: FILE LIST -->
                <div class="w-56 bg-slate-50 border-r border-slate-200 flex flex-col flex-none">
                    <div class="p-3 border-b border-slate-200 flex justify-between items-center bg-white">
                        <h2 id="md-category-title" class="text-xs font-bold text-slate-500 uppercase tracking-wider">...
                        </h2>
                        <button id="btn-add-doc" onclick="addNewDoc()"
                            class="hidden p-1 hover:bg-slate-100 rounded text-slate-500 transition"
                            title="Nieuw Bestand">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>

                    </div>
                    <div id="md-file-list" class="flex-1 overflow-y-auto p-2 space-y-0.5">
                        <!-- List Items Injected Here -->
                    </div>
                </div>

                <!-- RIGHT: CONTENT -->
                <div class="flex-1 flex flex-col overflow-hidden bg-white min-w-0">
                    <!-- Toolbar -->
                    <div class="border-b border-slate-200 bg-white p-3 flex justify-between items-center shadow-sm">
                        <h2 id="md-title" class="text-sm font-bold text-slate-800 truncate mr-4">Selecteer een
                            bestand...</h2>
                        <div class="space-x-2 flex-none flex items-center">
                            <button id="btn-edit-template" onclick="enableEditMode()"
                                class="hidden px-3 py-1.5 text-xs font-medium bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100">
                                <i data-lucide="edit-3" class="inline-block w-3 h-3 mr-1"></i> Bewerk (Template)
                            </button>
                            <button id="btn-delete-doc" onclick="deleteCurrentDoc()"
                                class="hidden px-2 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 rounded transition"
                                title="Verwijder dit bestand">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                            <button id="btn-save-doc" onclick="saveDoc()"
                                class="hidden px-2 py-1.5 text-xs font-medium text-green-600 hover:bg-green-50 rounded transition"
                                title="Opslaan (Lokaal)">
                                <i data-lucide="save" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-grow overflow-y-auto pl-2 pr-2 pt-1 relative">
                        <div id="md-loading"
                            class="hidden absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800"></div>
                        </div>

                        <div id="md-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg">
                            <h3 class="font-bold">Kan bestand niet laden</h3>
                            <p id="md-error-msg" class="text-sm mt-1">...</p>
                        </div>

                        <div id="md-content"
                            class="prose prose-slate max-w-none prose-headings:font-bold prose-a:text-blue-600">
                            <!-- Markdown rendered here -->
                        </div>

                        <textarea id="md-editor"
                            class="hidden w-full h-full p-4 font-mono text-sm border-0 focus:ring-0 resize-none outline-none"
                            spellcheck="false"></textarea>
                    </div>
                </div> <!-- End Right Pane -->
            </div>

        </div> <!-- End MAIN CONTENT AREA -->

    </div> <!-- End flex-grow container -->

    <!-- Markdown & Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="doc_registry.js"></script>
    <script>
        // Init Lucide icons
        lucide.createIcons();

        // Init Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default' });


        // --- NAVIGATION & FILESYSTEM LOGIC ---

        const isFileSystem = window.location.protocol === 'file:';
        const docBaseBase = window.location.href.substring(0, window.location.href.lastIndexOf('/')); // base dir of index.html

        // Update FS Status
        const fsInd = document.getElementById('fs-indicator');
        const localAccessUI = document.getElementById('local-access-ui');
        let projectHandle = null;

        if (isFileSystem) {
            fsInd.innerHTML = '<span class="text-orange-400 font-bold">‚ö†Ô∏è Lokaal Bestand Systeem</span><br>Beperkte functionaliteit.';
            localAccessUI.classList.remove('hidden');
        } else {
            fsInd.innerHTML = '<span class="text-green-400 font-bold">‚óè Web Server Mode</span><br>Volledige functionaliteit.';
        }

        // --- FILE SYSTEM ACCESS API ---
        async function startLocalSession() {
            try {
                projectHandle = await window.showDirectoryPicker();

                // Update UI
                fsInd.innerHTML = '<span class="text-green-400 font-bold">‚óè Local Access Active</span><br>Read/Write enabled.';
                localAccessUI.classList.add('hidden');

                alert("Verbonden met lokale map! Je kunt nu bestanden lezen en bewerken.");

                // Refresh current view if needed
                if (currentCategory) renderDocList(currentCategory);

            } catch (err) {
                console.error("Local session failed:", err);
                alert("Kon geen toegang krijgen tot de map. Probeer het opnieuw.");
            }
        }

        async function fetchLocalFile(path) {
            if (!projectHandle) throw new Error("No Project Handle");

            const parts = path.split('/');
            let dirHandle = projectHandle;

            // Traverse directories
            for (let i = 0; i < parts.length - 1; i++) {
                dirHandle = await dirHandle.getDirectoryHandle(parts[i]);
            }

            // Get File
            const fileHandle = await dirHandle.getFileHandle(parts[parts.length - 1]);
            const file = await fileHandle.getFile();
            return await file.text();
        }

        async function saveLocalFile(path, content) {
            if (!projectHandle) throw new Error("No Project Handle");

            const parts = path.split('/');
            let dirHandle = projectHandle;

            for (let i = 0; i < parts.length - 1; i++) {
                // Get or Create directory
                dirHandle = await dirHandle.getDirectoryHandle(parts[i], { create: true });
            }

            // Create File
            const fileHandle = await dirHandle.getFileHandle(parts[parts.length - 1], { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
        }

        async function verifyLocalFileDeletion(path) {
            if (!projectHandle) return;

            const parts = path.split('/');
            let dirHandle = projectHandle;

            for (let i = 0; i < parts.length - 1; i++) {
                dirHandle = await dirHandle.getDirectoryHandle(parts[i]);
            }
            await dirHandle.removeEntry(parts[parts.length - 1]);
        }

        // --- DOCUMENTATION REGISTRY & LOGIC ---
        // Loaded from doc_registry.js

        let currentCategory = null;
        let currentDocIndex = -1;

        // Render the Sidebar List for a Category
        function renderDocList(category) {
            currentCategory = category;
            const listContainer = document.getElementById('md-file-list');
            const catTitle = document.getElementById('md-category-title');
            const btnAdd = document.getElementById('btn-add-doc');

            // Hide Add Button in File Mode
            if (isFileSystem) {
                if (btnAdd) btnAdd.classList.add('hidden');
            } else {
                if (btnAdd) btnAdd.classList.remove('hidden');
            }

            if (!DOC_REGISTRY[category]) return;

            // Set Title
            catTitle.innerText = category.charAt(0).toUpperCase() + category.slice(1);

            // Clear & Rebuild List
            listContainer.innerHTML = '';
            DOC_REGISTRY[category].forEach((doc, index) => {
                const item = document.createElement('div');
                item.className = `p-2 text-xs cursor-pointer hover:bg-slate-100 rounded flex justify-between group ${index === currentDocIndex ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-600'}`;
                item.onclick = () => selectDoc(index);

                item.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i data-lucide="file-text" class="w-3 h-3 flex-none"></i>
                        <span class="truncate">${doc.name}</span>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        // Select a Document
        function selectDoc(index) {
            currentDocIndex = index;
            const doc = DOC_REGISTRY[currentCategory][index];
            const btnDelete = document.getElementById('btn-delete-doc');

            // Hide Delete Button in File Mode
            if (isFileSystem) {
                if (btnDelete) btnDelete.classList.add('hidden');
            } else {
                if (btnDelete) btnDelete.classList.remove('hidden');
            }

            if (doc) {
                // Rerender list to update selection state
                renderDocList(currentCategory);
                // Load Content
                loadMarkdown(doc.path);
            }
        }

        // Add New Document (Real Persistence)
        async function addNewDoc() {
            const name = prompt("Naam van nieuw document:");
            if (!name) return;

            const filename = name.toLowerCase().replace(/\s+/g, '-') + '.md';
            const path = `${currentCategory}/${filename}`;
            const initialContent = `# ${name}\n\nStart hier met typen...`;

            try {
                if (projectHandle) {
                    await saveLocalFile(path, initialContent);
                    alert("Bestand aangemaakt op schijf!");
                }

                // Add to Registry
                DOC_REGISTRY[currentCategory].push({ name, path });

                // Render
                renderDocList(currentCategory);

                // Select it
                selectDoc(DOC_REGISTRY[currentCategory].length - 1);

            } catch (e) {
                console.error(e);
                alert("Kon bestand niet aanmaken: " + e.message);
            }
        }

        async function deleteCurrentDoc() {
            if (currentDocIndex === -1) return;
            if (!confirm("Weet je zeker dat je dit bestand wilt verwijderen? (Dit is definitief)")) return;

            const doc = DOC_REGISTRY[currentCategory][currentDocIndex];

            try {
                if (projectHandle) {
                    await verifyLocalFileDeletion(doc.path);
                }

                DOC_REGISTRY[currentCategory].splice(currentDocIndex, 1);
                currentDocIndex = -1;

                renderDocList(currentCategory);

                // Clear view
                document.getElementById('md-content').innerHTML = '<div class="text-xs text-slate-400 p-4 text-center italic">Selecteer een bestand...</div>';
                document.getElementById('md-title').innerText = '...';

            } catch (e) {
                console.error(e);
                alert("Kon bestand niet verwijderen: " + e.message);
            }
        }

        async function saveDoc() {
            const content = document.getElementById('md-editor').value;
            try {
                if (projectHandle) {
                    // Get current path using currentDocIndex 
                    // (Assuming currentCategory and currentDocIndex are valid)
                    const doc = DOC_REGISTRY[currentCategory][currentDocIndex];
                    if (doc) {
                        await saveLocalFile(doc.path, content);
                        alert("Opgeslagen!");

                        // Exit Edit Mode
                        enableEditMode();
                    }
                } else {
                    alert("Geen lokale toegang. Kan niet opslaan.");
                }
            } catch (e) {
                console.error(e);
                alert("Fout bij opslaan: " + e.message);
            }
        }

        let currentPath = '';

        function navTo(view, path = null) {
            const btnContainer = document.getElementById('top-nav-actions');
            const vArch = document.getElementById('view-arch');
            const vMd = document.getElementById('view-markdown');

            // Toggle Views
            if (view === 'arch') {
                // Show Arch
                vArch.classList.remove('hidden');
                vArch.style.display = 'flex'; // Enforce Flex

                // Hide Markdown
                vMd.classList.add('hidden');
                vMd.style.display = 'none';

                if (btnContainer) btnContainer.classList.remove('hidden');
            } else if (view === 'dir') {
                // Hide Arch
                vArch.classList.add('hidden');
                vArch.style.display = 'none';

                // Show Markdown
                vMd.classList.remove('hidden');
                vMd.style.display = 'flex'; // Enforce Flex (it has flex-row)

                // path argument is now the Category Key
                renderDocList(path);

                // Auto-select first doc if available
                if (DOC_REGISTRY[path] && DOC_REGISTRY[path].length > 0) {
                    selectDoc(0);
                } else {
                    document.getElementById('md-content').innerHTML = '<div class="text-xs text-slate-400 p-8 text-center italic">Geen bestanden.</div>';
                    document.getElementById('md-title').innerText = '...';
                }

                if (btnContainer) btnContainer.classList.add('hidden');
            }
        }

        async function loadMarkdown(path) {
            currentPath = path;
            const mdContainer = document.getElementById('md-content');
            const mdError = document.getElementById('md-error');
            const mdErrorMsg = document.getElementById('md-error-msg');
            const mdLoading = document.getElementById('md-loading');
            const btnEdit = document.getElementById('btn-edit-template');

            // Reset UI
            mdContainer.innerHTML = '';
            mdContainer.classList.remove('hidden');
            document.getElementById('md-editor').classList.add('hidden');
            mdError.classList.add('hidden');
            mdLoading.classList.remove('hidden');
            document.getElementById('md-title').innerText = path;

            // Configure buttons based on Environment
            if (isFileSystem) {
                btnEdit.classList.add('hidden');
            } else {
                btnEdit.classList.remove('hidden');
            }

            try {
                let text = '';

                if (projectHandle) {
                    // Try Local Handle First
                    text = await fetchLocalFile(path);
                } else {
                    // Fallback to Fetch
                    // In file mode, fetch() often throws CORS or Network error immediately
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    text = await response.text();
                }

                mdContainer.innerHTML = marked.parse(text);

                // Render Mermaid Diagrams
                // 1. Find all code blocks with 'language-mermaid'
                const mermaidBlocks = mdContainer.querySelectorAll('pre code.language-mermaid');

                const promises = [];
                mermaidBlocks.forEach((block, index) => {
                    const rawMermaid = block.textContent;
                    const pre = block.parentElement; // The <pre> tag

                    // Create replacement div
                    const div = document.createElement('div');
                    div.classList.add('mermaid');
                    div.textContent = rawMermaid;
                    div.id = `mermaid-${Date.now()}-${index}`;

                    // Replace <pre> with <div>
                    pre.replaceWith(div);
                });

                // Run Mermaid
                try {
                    await mermaid.run({
                        querySelector: '.mermaid'
                    });
                } catch (err) {
                    console.error("Mermaid Render Error:", err);
                }

            } catch (err) {
                console.warn("Markdown fetch failed:", err);

                if (isFileSystem && !projectHandle) {
                    mdErrorMsg.innerHTML = `
                        <b>Browser Beveiliging:</b> Direct laden van lokale bestanden is geblokkeerd.<br>
                        Klik op <b>"Open Project Folder"</b> in het menu om toegang te krijgen.
                        <br><br>
                        <a href="${path}" target="_blank" class="underline text-red-800 font-bold">Of open handmatig</a>
                    `;
                } else {
                    mdErrorMsg.innerText = err.message;
                }
                mdError.classList.remove('hidden');
            } finally {
                mdLoading.classList.add('hidden');

                // Add Link Interceptor for .md files
                mdContainer.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('.md') && !href.startsWith('http')) {
                        link.onclick = (e) => {
                            e.preventDefault();
                            // Resolve relative path
                            // Simple resolution: if starts with ../, go up. 
                            // Since we have specific folders, we can hack it or use a proper resolver.
                            // doc_registry uses relative paths from root: 'skills/research.md'
                            // currentPath might be 'bouwblokken/druppie_ui.md'
                            // href might be '../skills/research.md'

                            let targetPath = href;
                            // Very basic resolution for ../
                            if (currentPath && href.startsWith('../')) {
                                // removing one level folder
                                // We know our structure is flat 1-level folders mostly
                                // ../skills/x -> skills/x
                                targetPath = href.substring(3);
                            } else if (currentPath && !href.startsWith('/')) {
                                // sibling
                                // bouwblokken/x.md + y.md -> bouwblokken/y.md
                                const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                                targetPath = currentDir + href;
                                // Handle ./
                                if (targetPath.includes('/./')) targetPath = targetPath.replace('/./', '/');
                            }

                            // Normalize (naive)
                            if (targetPath.startsWith('./')) targetPath = targetPath.substring(2);

                            console.log("Navigating to internal MD:", targetPath);
                            loadMarkdown(targetPath);
                        };
                    }
                });
            }
        }

        function openLocalFile() {
            window.open(currentPath, '_blank');
        }

        function enableEditMode(force = false) {
            const container = document.getElementById('md-content');
            const editor = document.getElementById('md-editor');
            const btnEdit = document.getElementById('btn-edit-template');
            const btnSave = document.getElementById('btn-save-doc');

            // Force Edit Mode (for new files)
            if (force) {
                editor.classList.remove('hidden');
                container.classList.add('hidden');
                btnEdit.innerHTML = '<i data-lucide="x" class="inline-block w-3 h-3 mr-1"></i> Annuleren';
                if (projectHandle) btnSave.classList.remove('hidden');
                return;
            }

            if (editor.classList.contains('hidden')) {
                // Switch to Edit
                // We need the raw text. Fetch again.
                // If local, we can use fetchLocalFile logic implicitly or fetch again.
                // Ideally loadMarkdown populated a global rawText, but fetching is fast.

                // Using the simple logic from before, assuming we can get text.
                // For now, simpler: just toggle UI, assume user clicked because they see content.
                // WE NEED TO FETCH CONTENT TO EDITOR
                const doc = DOC_REGISTRY[currentCategory][currentDocIndex];
                if (doc) {
                    // Trigger a load into editor? Or just fetch here.
                    // Let's rely on fetchLocalFile being available globally or duplicate logic?
                    // Better: Make loadMarkdown populate the editor value too? No.

                    // Async fetch for editor
                    (async () => {
                        try {
                            let text = '';
                            if (projectHandle) text = await fetchLocalFile(doc.path);
                            else {
                                const res = await fetch(doc.path);
                                text = await res.text();
                            }
                            editor.value = text;

                            editor.classList.remove('hidden');
                            container.classList.add('hidden');

                            btnEdit.innerHTML = '<i data-lucide="x" class="inline-block w-3 h-3 mr-1"></i> Annuleren';
                            if (projectHandle) btnSave.classList.remove('hidden');

                        } catch (e) {
                            alert("Kan bestand niet laden voor bewerking.");
                        }
                    })();
                }

            } else {
                // Switch back (Cancel / Done)
                editor.classList.add('hidden');
                container.classList.remove('hidden');
                btnEdit.innerHTML = '<i data-lucide="edit-3" class="inline-block w-3 h-3 mr-1"></i> Bewerk';
                btnSave.classList.add('hidden');

                // Re-render PREVIOUS content (discard changes if cancel)
                // Actually loadMarkdown renders `md-content`. 
                // So we can just call loadMarkdown(currentPath) -- wait, we have selectDoc logic.
                const doc = DOC_REGISTRY[currentCategory][currentDocIndex];
                if (doc) loadMarkdown(doc.path);
            }
        }

    </script>
</body>

</html>