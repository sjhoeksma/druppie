<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Druppie">
    <meta name="theme-color" content="#0f172a">
    <title>Druppie</title>
    <link rel="icon" type="image/svg+xml" href="../druppie_logo.svg">
    <link rel="apple-touch-icon" href="../druppie_logo.png">
    <link rel="manifest" href="../manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="common.js"></script>

    <style>
        :root {
            --bg-deep: #0f172a;
            --bg-card: #1e293b;
            --accent: #38bdf8;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            color: #f1f5f9;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Login View -->
    <div id="view-login" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-[#0f172a]">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <div class="flex flex-col items-center mb-8">
                <img src="../druppie_logo.svg" class="w-16 h-16 rounded-xl shadow-lg mb-4">
                <h2 class="text-2xl font-bold tracking-tight">Druppie</h2>
                <p class="text-slate-400 text-sm mt-1">Admin Access</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="text" id="login-username" name="username" autocomplete="username"
                        class="w-full bg-[#1e293b] border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] transition-all"
                        placeholder="Username">
                </div>
                <div>
                    <input type="password" id="login-password" name="password" autocomplete="current-password"
                        class="w-full bg-[#1e293b] border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] transition-all"
                        placeholder="Password">
                </div>
                <div id="login-error"
                    class="text-red-400 text-sm hidden text-center bg-red-500/10 p-2 rounded-lg border border-red-500/20">
                    Invalid credentials</div>
                <button type="submit"
                    class="w-full bg-[#38bdf8] hover:bg-[#0ea5e9] text-[#0f172a] font-bold py-3 rounded-xl transition-colors shadow-lg shadow-blue-500/20">Sign
                    In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard View -->
    <!-- Dashboard View -->
    <div id="view-dashboard" class="hidden flex-col h-full bg-[#0f172a] relative overflow-hidden">
        <!-- Header -->
        <header
            class="flex-none bg-[#1e293b] border-b border-slate-800 p-4 flex items-center justify-between z-20 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-center">
                    <img src="../druppie_logo.svg" class="w-8 h-8 rounded-lg">
                    <div id="app-version" style="font-size: 0.55rem; color: #94a3b8; line-height: 1; margin-top: 2px;">
                        v...</div>
                </div>
                <span class="font-semibold text-white tracking-tight">Druppie Admin</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <div class="font-semibold text-white text-sm" id="current-user-name">Admin</div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Online</div>
                    </div>
                    <div id="header-avatar"
                        class="w-9 h-9 rounded-lg bg-gradient-to-br from-[#38bdf8] to-blue-600 flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-blue-500/20">
                        A</div>
                </div>
                <button onclick="app.logout()"
                    class="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg transition-all"
                    title="Sign Out">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex-none border-b border-slate-800 bg-[#1e293b]/50">
            <div class="flex items-center justify-between max-w-6xl mx-auto w-full px-4 md:px-8">
                <div class="flex gap-1 overflow-x-auto">
                    <button onclick="app.setTab('users')" id="nav-users"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">Users</button>
                    <button onclick="app.setTab('groups')" id="nav-groups"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">Groups</button>
                    <button onclick="app.setTab('config')" id="nav-config"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">Config</button>
                    <button onclick="app.setTab('mcp')" id="nav-mcp"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">MCP</button>
                    <button onclick="app.setTab('agents')" id="nav-agents"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">Agents</button>
                    <button onclick="app.setTab('skills')" id="nav-skills"
                        class="px-4 py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-white transition-all whitespace-nowrap">Skills</button>
                </div>
                <button id="btn-add-generic" onclick="app.addItem()"
                    class="bg-[#38bdf8] hover:bg-[#0ea5e9] text-[#0f172a] px-4 py-1.5 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span id="btn-add-text">Add</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto w-full">

                <!-- Users View -->
                <div id="content-users" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full">


                    <div class="bg-[#1e293b] border border-slate-700/50 rounded-2xl overflow-hidden shadow-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead
                                    class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider font-semibold">
                                    <tr>
                                        <th class="p-4 md:pl-6">User</th>
                                        <th class="p-4 hidden md:table-cell">Groups</th>
                                        <th class="p-4 text-right md:pr-6">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50" id="table-users-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Groups View -->
                <div id="content-groups" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full">


                    <div class="bg-[#1e293b] border border-slate-700/50 rounded-2xl overflow-hidden shadow-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead
                                    class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider font-semibold">
                                    <tr>
                                        <th class="p-4 md:pl-6">Group Info</th>
                                        <th class="p-4 hidden md:table-cell">Nested Groups</th>
                                        <th class="p-4 text-right md:pr-6">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50" id="table-groups-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Config View -->
                <div id="content-config" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full text-white">
                    <div class="bg-[#1e293b] border border-slate-700/50 p-6 rounded-2xl">
                        <h2 class="text-lg font-semibold mb-4">System Configuration</h2>
                        <textarea id="config-editor"
                            class="w-full h-96 bg-slate-900 border border-slate-700 rounded-lg p-4 font-mono text-xs text-slate-300"></textarea>
                        <div class="mt-4 text-right">
                            <button onclick="app.saveConfig()"
                                class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white font-bold">Save
                                Config</button>
                        </div>
                    </div>
                </div>

                <!-- MCP View -->
                <div id="content-mcp" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full">
                    <div class="bg-[#1e293b] border border-slate-700/50 rounded-2xl overflow-hidden shadow-xl">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800/50 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="p-4">Server</th>
                                    <th class="p-4">URL</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-mcp-body" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Agents View -->
                <div id="content-agents" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full">
                    <div class="bg-[#1e293b] border border-slate-700/50 rounded-2xl overflow-hidden shadow-xl">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800/50 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="p-4">Agent</th>
                                    <th class="p-4">Type</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-agents-body" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Skills View -->
                <div id="content-skills" class="hidden p-4 md:p-8 max-w-6xl mx-auto w-full">
                    <div class="bg-[#1e293b] border border-slate-700/50 rounded-2xl overflow-hidden shadow-xl">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800/50 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="p-4">Skill</th>
                                    <th class="p-4">Description</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-skills-body" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-wrapper"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div
            class="bg-[#1e293b] border border-slate-700 rounded-2xl w-full max-w-lg relative shadow-2xl modal-content transform transition-all scale-100">
            <button onclick="document.getElementById('modal-wrapper').classList.add('hidden')"
                class="absolute top-4 right-4 p-2 text-slate-400 hover:text-white bg-slate-800/50 rounded-full transition-colors">&times;</button>
            <div class="p-6 md:p-8">
                <h3 id="modal-title" class="text-2xl font-bold mb-6">Edit</h3>
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Reusable Search Combo Component
        class SearchCombo {
            constructor(container, items, selectedIds, placeholder, onChange) {
                this.container = container;
                this.items = items; // {id, name, ...}
                this.selectedIds = new Set(selectedIds);
                this.onChange = onChange;
                this.placeholder = placeholder;
                this.isOpen = false;
                this.render();
            }

            render() {
                this.container.innerHTML = '';
                this.container.className = "relative";

                // Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = "w-full bg-slate-900 border border-slate-700 rounded-xl p-2 flex flex-wrap gap-2 transition-all focus-within:border-[#38bdf8] focus-within:ring-1 focus-within:ring-[#38bdf8]";

                // Render Selected Tags
                this.selectedIds.forEach(id => {
                    const item = this.items.find(i => i.id === id || i.username === id) || { id, name: id };
                    const tag = document.createElement('span');
                    tag.className = "bg-slate-700 text-slate-200 text-xs px-2 py-1 rounded-lg flex items-center gap-1 border border-slate-600";
                    tag.innerHTML = `
                        <span>${item.name || item.username || item.id}</span>
                        <button type="button" class="text-slate-400 hover:text-white rounded-full p-0.5 hover:bg-slate-600 transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    tag.querySelector('button').onclick = (e) => {
                        e.stopPropagation();
                        this.toggleSelection(id);
                    };
                    wrapper.appendChild(tag);
                });

                // Input
                const input = document.createElement('input');
                input.className = "bg-transparent border-none outline-none text-white text-sm flex-1 min-w-[120px] placeholder-slate-500 py-1";
                input.placeholder = this.selectedIds.size === 0 ? this.placeholder : "";

                // Dropdown
                const dropdown = document.createElement('div');
                dropdown.className = "absolute top-full left-0 right-0 mt-1 bg-[#1e293b] border border-slate-700 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50 hidden";

                // Event Listeners
                input.onfocus = () => { dropdown.classList.remove('hidden'); this.filter(input.value, dropdown); };
                input.oninput = () => { this.filter(input.value, dropdown); };

                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) dropdown.classList.add('hidden');
                });

                wrapper.appendChild(input);
                this.container.appendChild(wrapper);
                this.container.appendChild(dropdown);

                this.dropdown = dropdown;
            }

            filter(query, dropdown) {
                const q = query.toLowerCase();
                const available = this.items.filter(i => !this.selectedIds.has(i.id || i.username));
                const filtered = available.filter(i => (i.name || i.username || i.id).toLowerCase().includes(q) || (i.id || "").toLowerCase().includes(q));

                dropdown.innerHTML = '';
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="p-3 text-slate-500 text-sm italic text-center">No results found</div>';
                } else {
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "p-2.5 hover:bg-slate-800 cursor-pointer text-sm flex items-center justify-between group transition-colors";
                        div.innerHTML = `<span class="text-white font-medium group-hover:text-[#38bdf8]">${item.name || item.username}</span> <span class="text-xs text-slate-500 font-mono">${item.id || item.username}</span>`;
                        div.onclick = () => {
                            this.toggleSelection(item.id || item.username);
                            this.dropdown.classList.add('hidden');
                        };
                        dropdown.appendChild(div);
                    });
                }
            }

            toggleSelection(id) {
                if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                else this.selectedIds.add(id);
                this.render();
                if (this.onChange) this.onChange(Array.from(this.selectedIds));
            }
        }

        const app = {
            state: {
                user: null,
                token: localStorage.getItem('druppie_token'),
                users: [],
                groups: [],
                view: 'users'
            },

            init: async () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('view')) app.state.view = urlParams.get('view');

                // Fetch Version
                // Fetch Version handled by common.js

                // Load User
                const storedUser = localStorage.getItem('druppie_user');
                if (storedUser) {
                    try {
                        app.state.user = JSON.parse(storedUser);
                        // Update Header
                        document.getElementById('current-user-name').innerText = app.state.user.username;
                        document.getElementById('header-avatar').innerText = app.state.user.username.substring(0, 2).toUpperCase();
                    } catch (e) { }
                }

                if (!app.state.token) { app.showView('login'); return; }
                try {
                    await app.fetchData();
                    app.showView('dashboard');
                } catch (e) { console.error("Auth failed", e); app.logout(); }
            },

            addItem: () => {
                if (app.state.view === 'users') app.modalUser();
                else if (app.state.view === 'groups') app.modalGroup();
                else if (app.state.view === 'mcp') alert('Add MCP not implemented yet');
                else if (app.state.view === 'agents') alert('Add Agent not implemented yet');
                else if (app.state.view === 'skills') alert('Add Skill not implemented yet');
            },

            showView: (view) => {
                document.getElementById('view-login').classList.toggle('hidden', view !== 'login');
                document.getElementById('view-dashboard').classList.toggle('hidden', view !== 'dashboard');
                if (view === 'dashboard') {
                    document.getElementById('view-dashboard').classList.add('flex');
                    app.setTab(app.state.view);
                } else {
                    document.getElementById('view-dashboard').classList.remove('flex');
                }
            },

            setTab: (tab) => {
                app.state.view = tab;
                const tabs = ['users', 'groups', 'config', 'mcp', 'agents', 'skills'];

                tabs.forEach(t => {
                    const content = document.getElementById('content-' + t);
                    if (content) content.classList.toggle('hidden', t !== tab);

                    const btn = document.getElementById('nav-' + t);
                    if (t === tab) {
                        btn.classList.add('border-b-[#38bdf8]', 'text-white');
                        btn.classList.remove('border-transparent', 'text-slate-400');
                    } else {
                        btn.classList.remove('border-b-[#38bdf8]', 'text-white');
                        btn.classList.add('border-transparent', 'text-slate-400');
                    }
                });

                // Button Logic
                const btnAdd = document.getElementById('btn-add-generic');
                if (tab === 'config' || tab === 'mcp' || tab === 'agents' || tab === 'skills') {
                    btnAdd.style.display = 'none';
                } else {
                    btnAdd.style.display = 'flex';
                    const map = { users: 'Add', groups: 'Add', mcp: 'Add', agents: 'Add', skills: 'Add' };
                    document.getElementById('btn-add-text').innerText = map[tab] || 'Add';
                }

                app.renderData();
            },

            fetchData: async () => {
                const headers = { 'Authorization': 'Bearer ' + app.state.token };
                const endpoints = ['/v1/iam/users', '/v1/iam/groups', '/v1/config', '/v1/mcp', '/v1/agents', '/v1/skills'];

                try {
                    const responses = await Promise.all(endpoints.map(e => fetch(e, { headers })));

                    // Check for 401
                    for (let r of responses) {
                        if (r.status === 401) {
                            app.logout();
                            return;
                        }
                    }

                    const data = await Promise.all(responses.map(r => r.ok ? r.json() : []));

                    app.state.users = data[0];
                    app.state.groups = data[1];
                    app.state.config = data[2];
                    app.state.mcp = data[3];
                    app.state.agents = data[4];
                    app.state.skills = data[5];

                } catch (e) {
                    console.error("Fetch error", e);
                }

                app.renderData();
            },

            saveConfig: async () => {
                try {
                    const json = document.getElementById('config-editor').value;
                    const body = JSON.parse(json); // Validate JSON
                    const res = await fetch('/v1/config', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: json
                    });
                    if (res.ok) alert('Config Saved!');
                    else alert('Error saving config');
                } catch (e) {
                    alert('Invalid JSON');
                }
            },

            renderData: () => {
                // Users
                if (app.state.users) {
                    document.getElementById('table-users-body').innerHTML = (app.state.users || []).map(u => `
                        <tr onclick="app.modalUser('${u.username}')" class="hover:bg-slate-800/30 transition-colors group cursor-pointer">
                            <td class="p-4 md:pl-6"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center font-bold text-sm border border-slate-700 text-white">${u.username.substring(0, 2).toUpperCase()}</div><div class="min-w-0"><div class="font-semibold text-white truncate">${u.username}</div><div class="text-xs text-slate-500 truncate">${u.email}</div></div></div></td>
                            <td class="p-4 hidden md:table-cell"><div class="flex flex-wrap gap-1.5">${(u.groups || []).length ? (u.groups || []).map(g => `<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-slate-800 text-slate-300 border border-slate-700">${g}</span>`).join('') : '<span class="text-slate-600 italic text-xs">No groups</span>'}</div></td>
                            <td class="p-4 text-right md:pr-6">${u.username !== 'admin' ? `<button onclick="event.stopPropagation(); app.deleteUser('${u.username}')" class="text-slate-400 hover:text-red-400 p-2 hover:bg-red-500/10 rounded-lg transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : ''}</td>
                        </tr>`).join('');
                }

                // Groups
                if (app.state.groups) {
                    document.getElementById('table-groups-body').innerHTML = (app.state.groups || []).map(g => `
                        <tr onclick="app.modalGroup('${g.id}')" class="hover:bg-slate-800/30 transition-colors cursor-pointer">
                            <td class="p-4 md:pl-6"><div class="flex flex-col"><span class="font-semibold text-white">${g.name}</span><span class="text-xs font-mono text-slate-500 mt-0.5">${g.id}</span></div></td>
                            <td class="p-4 hidden md:table-cell"><div class="flex flex-wrap gap-1.5">${(g.member_groups || []).length ? (g.member_groups || []).map(mg => `<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-slate-800 text-slate-300 border border-slate-700"><svg class="w-3 h-3 mr-1 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>${mg}</span>`).join('') : '<span class="text-slate-600 italic text-xs">None</span>'}</div></td>
                            <td class="p-4 text-right md:pr-6"><button onclick="event.stopPropagation(); app.deleteGroup('${g.id}')" class="text-slate-400 hover:text-red-400 p-2 hover:bg-red-500/10 rounded-lg transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>
                        </tr>`).join('');
                }

                // Config
                if (app.state.view === 'config' && app.state.config) {
                    // Only set value if not focused to avoid overwrite? No, simple logic for now.
                    // Better: only set on fetch?
                    if (!document.activeElement || document.activeElement.id !== 'config-editor') {
                        document.getElementById('config-editor').value = JSON.stringify(app.state.config, null, 2);
                    }
                }

                // Others
                if (app.state.view === 'mcp' && app.state.mcp) {
                    document.getElementById('table-mcp-body').innerHTML = app.state.mcp.map(m => `
                        <tr class="hover:bg-slate-800/30 transition-colors">
                            <td class="p-4"><div class="font-semibold text-white">${m.name}</div><div class="text-xs text-slate-500">${m.id}</div></td>
                            <td class="p-4 text-slate-300 font-mono text-xs">${m.url}</td>
                            <td class="p-4 text-right"></td>
                        </tr>`).join('');
                }
                if (app.state.view === 'agents' && app.state.agents) {
                    document.getElementById('table-agents-body').innerHTML = app.state.agents.map(a => `
                        <tr class="hover:bg-slate-800/30 transition-colors">
                            <td class="p-4"><div class="font-semibold text-white">${a.name}</div><div class="text-xs text-slate-500">${a.id}</div></td>
                            <td class="p-4 text-slate-300">${a.type}</td>
                            <td class="p-4 text-right"></td>
                        </tr>`).join('');
                }
                if (app.state.view === 'skills' && app.state.skills) {
                    document.getElementById('table-skills-body').innerHTML = app.state.skills.map(s => `
                        <tr class="hover:bg-slate-800/30 transition-colors">
                            <td class="p-4"><div class="font-semibold text-white">${s.name}</div><div class="text-xs text-slate-500">${s.id}</div></td>
                            <td class="p-4 text-slate-300 text-sm truncate max-w-xs">${s.description || ''}</td>
                            <td class="p-4 text-right"></td>
                        </tr>`).join('');
                }
            },

            // Login/Logout/Delete same as before
            login: async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch('/v1/iam/login', { method: 'POST', body: JSON.stringify({ username: document.getElementById('login-username').value, password: document.getElementById('login-password').value }) });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    localStorage.setItem('druppie_token', data.token);
                    localStorage.setItem('druppie_user', JSON.stringify(data.user));
                    app.state.token = data.token;
                    location.reload();
                } catch { document.getElementById('login-error').classList.remove('hidden'); }
            },
            logout: async () => { await fetch('/v1/iam/logout', { method: 'POST', headers: {} }); localStorage.removeItem('druppie_token'); localStorage.removeItem('druppie_user'); location.reload(); },
            deleteUser: async (u) => { if (confirm("Delete user " + u + "?")) { await fetch(`/v1/iam/users/${u}`, { method: 'DELETE', headers: {} }); app.fetchData(); } },
            deleteGroup: async (id) => { if (confirm("Delete group " + id + "?")) { await fetch(`/v1/iam/groups/${id}`, { method: 'DELETE', headers: {} }); app.fetchData(); } },

            // Enhanced Modals
            modalUser: (username = null) => {
                const isEdit = !!username;
                const user = isEdit ? app.state.users.find(u => u.username === username) : { username: '', email: '', groups: [] };

                document.getElementById('modal-title').innerText = isEdit ? 'Edit User' : 'New User';
                document.getElementById('modal-content').innerHTML = `
                     <form onsubmit="app.saveUser(event, '${username || ''}')" class="space-y-4">
                        ${!isEdit ? `<div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-1.5">Username</label><input name="username" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] outline-none transition-all" required placeholder="e.g. john.doe"></div>` : ''}
                        <div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-1.5">Email</label><input name="email" type="email" value="${user.email}" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] outline-none transition-all" placeholder="user@druppie.local"></div>
                        <div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-1.5">Password ${isEdit ? '<span class="text-slate-600 font-normal lowercase ml-1">(Optional)</span>' : ''}</label><input name="password" type="password" autocomplete="new-password" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] outline-none transition-all" placeholder="••••••••"></div>
                        <div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-2">Member of Groups</label><div id="combo-groups"></div></div>
                        <div class="pt-2"><button type="submit" class="w-full bg-[#38bdf8] hover:bg-[#0ea5e9] text-[#0f172a] font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-500/20">Save User</button></div>
                    </form>`;

                // Init Search Combo
                app.currentUserGroups = user.groups || [];
                new SearchCombo(document.getElementById('combo-groups'), app.state.groups, app.currentUserGroups, "Search groups...", (selected) => { app.currentUserGroups = selected; });
                document.getElementById('modal-wrapper').classList.remove('hidden');
            },

            saveUser: async (e, username) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd);
                data.groups = app.currentUserGroups || []; // From Combo state

                const method = username ? 'PUT' : 'POST';
                const url = username ? `/v1/iam/users/${username}` : '/v1/iam/users';

                await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                document.getElementById('modal-wrapper').classList.add('hidden');
                app.fetchData();
            },

            modalGroup: (id = null) => {
                const isEdit = !!id;
                const group = isEdit ? app.state.groups.find(g => g.id === id) : { id: '', name: '', member_groups: [] };
                const groupUsers = app.state.users.filter(u => (u.groups || []).includes(group.id));
                const usersInGroup = groupUsers.map(u => u.username);

                document.getElementById('modal-title').innerText = isEdit ? 'Edit Group' : 'New Group';
                document.getElementById('modal-content').innerHTML = `
                    <form onsubmit="app.saveGroup(event, '${id || ''}')" class="space-y-4">
                        <div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-1.5">Name</label><input name="name" value="${group.name}" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] outline-none transition-all" required autofocus></div>
                        ${!isEdit ? `<div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-1.5">Group ID <span class="text-slate-600 font-normal lowercase ml-1">(Optional)</span></label><input name="id" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:border-[#38bdf8] focus:ring-1 focus:ring-[#38bdf8] outline-none transition-all" placeholder="Auto-generated from Name if empty"></div>` : ''}
                        <div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-2">Include Nested Groups</label><div id="combo-nested"></div></div>
                        ${isEdit ? `<div><label class="block text-xs uppercase font-bold text-slate-500 tracking-wider mb-2">Members (Users)</label><div id="combo-members"></div></div>` : ''}
                        <div class="pt-2"><button class="w-full bg-[#38bdf8] hover:bg-[#0ea5e9] text-[#0f172a] font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-500/20">Save Group</button></div>
                    </form>`;

                app.currentNested = group.member_groups || [];
                new SearchCombo(document.getElementById('combo-nested'), app.state.groups.filter(g => g.id !== id), app.currentNested, "Add nested group...", (s) => app.currentNested = s);

                if (isEdit) {
                    app.currentMembers = usersInGroup;
                    new SearchCombo(document.getElementById('combo-members'), app.state.users, usersInGroup, "Add user to group...", (s) => app.currentMembers = s);
                }
                document.getElementById('modal-wrapper').classList.remove('hidden');
            },

            saveGroup: async (e, id) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd);
                data.member_groups = app.currentNested || [];

                // 1. Save Group
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/v1/iam/groups/${id}` : '/v1/iam/groups';
                const res = await fetch(url, { method: method, headers: {}, body: JSON.stringify(data) });
                if (!res.ok) return alert("Error saving group");

                // 2. Handle Members Update (Only on Edit and if updated)
                if (id && app.currentMembers) {
                    const originalMembers = new Set(app.state.users.filter(u => (u.groups || []).includes(id)).map(u => u.username));
                    const newMembers = new Set(app.currentMembers);

                    const toAdd = [...newMembers].filter(x => !originalMembers.has(x));
                    const toRemove = [...originalMembers].filter(x => !newMembers.has(x));

                    const updates = [];
                    // Add
                    toAdd.forEach(username => {
                        const u = app.state.users.find(u => u.username === username);
                        if (u) {
                            const newGroups = [...(u.groups || []), id]; // Add group
                            updates.push(fetch(`/v1/iam/users/${username}`, { method: 'PUT', headers: {}, body: JSON.stringify({ ...u, groups: newGroups }) }));
                        }
                    });
                    // Remove
                    toRemove.forEach(username => {
                        const u = app.state.users.find(u => u.username === username);
                        if (u) {
                            const newGroups = (u.groups || []).filter(g => g !== id); // Remove group
                            updates.push(fetch(`/v1/iam/users/${username}`, { method: 'PUT', headers: {}, body: JSON.stringify({ ...u, groups: newGroups }) }));
                        }
                    });

                    await Promise.all(updates);
                }

                document.getElementById('modal-wrapper').classList.add('hidden');
                app.fetchData();
            }
        };

        document.getElementById('login-form').onsubmit = app.login;
        app.init();
    </script>
</body>

</html>